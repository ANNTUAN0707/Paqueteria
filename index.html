<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paqueter√≠a M√≥vil - Navegaci√≥n en Tiempo Real</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    #map {
      height: 100vh;
      width: 100%;
      transition: margin-left 0.3s ease;
    }
    .sidebar {
      height: 100%;
      width: 0;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 2000;
      background: white;
      overflow-x: hidden;
      transition: width 0.3s ease;
      padding: 1rem;
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .sidebar-open {
      width: 320px;
    }
    .sidebar h2 {
      margin: 0;
      font-size: 1.5rem;
      color: #1f2937;
      text-align: center;
    }
    .dest-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.5rem;
      background: #f9fafb;
    }
    .dest-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .dest-list-item:hover {
      background: #e0f2fe;
    }
    .route-info {
      padding: 0.75rem;
      background: #ecfdf5;
      border-radius: 8px;
      color: #065f46;
      text-align: center;
      font-size: 0.9rem;
    }
    .openbtn {
      position: absolute;
      top: 1rem;
      left: 1rem;
      z-index: 2100;
      padding: 0.75rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background 0.3s;
    }
    @media (max-width: 480px) {
      .sidebar-open {
        width: 100%;
      }
      .sidebar h2 {
        font-size: 1.25rem;
      }
      .openbtn {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <button class="openbtn bg-blue-600 text-white hover:bg-blue-700" onclick="openSidebar()" aria-label="Abrir men√∫ de destinos">
    ‚ò∞ Destinos
  </button>

  <div id="map"></div>

  <div id="mySidebar" class="sidebar">
    <h2>Destinos</h2>
    <input id="address" class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" placeholder="Buscar direcci√≥n" aria-label="Buscar direcci√≥n"/>
    <button onclick="addAddress()" class="bg-green-600 text-white py-2 rounded-lg hover:bg-green-700" aria-label="Agregar destino">Agregar destino</button>
    <div class="dest-list" id="destList"></div>
    <button onclick="findNearest()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700" aria-label="Buscar destino m√°s cercano">Destino m√°s cercano</button>
    <select id="destSelect" class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" aria-label="Seleccionar destino"></select>
    <button onclick="goToSelected()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700" aria-label="Ir al destino seleccionado">Ir</button>
    <button onclick="locateMe()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700" aria-label="Mostrar mi ubicaci√≥n">D√≥nde estoy</button>
    <div class="route-info" id="routeInfo">Ruta vac√≠a</div>
    <button onclick="setManualLocation()" class="bg-yellow-600 text-white py-2 rounded-lg hover:bg-yellow-700" aria-label="Establecer ubicaci√≥n manual">Ubicaci√≥n manual</button>
    <button onclick="closeSidebar()" class="bg-red-600 text-white py-2 rounded-lg hover:bg-red-700" aria-label="Cerrar men√∫">Cerrar</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script>
    // Inicializaci√≥n del mapa
    const map = L.map('map').setView([23.6345, -102.5528], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let destinations = [], markers = [], routingControl = null;
    let routeInstructions = [], nextInstructionIndex = 0;
    let userMarker = null;

    // Funci√≥n para evitar m√∫ltiples ejecuciones r√°pidas
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Gesti√≥n de la barra lateral
    function openSidebar() {
      document.getElementById('mySidebar').classList.add('sidebar-open');
      map.getContainer().style.marginLeft = '320px';
      map.invalidateSize();
    }

    function closeSidebar() {
      document.getElementById('mySidebar').classList.remove('sidebar-open');
      map.getContainer().style.marginLeft = '0';
      map.invalidateSize();
    }

    // Funci√≥n de voz
    function speak(text) {
      if (!text || !window.speechSynthesis) return;
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'es-MX';
      msg.rate = 1;
      window.speechSynthesis.speak(msg);
    }

    // Agregar destino
    async function addAddress() {
      const query = document.getElementById('address').value.trim();
      if (!query) {
        alert('Por favor, ingresa una direcci√≥n v√°lida.');
        return;
      }
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (!data.length) {
          alert('Direcci√≥n no encontrada.');
          return;
        }
        const { lat, lon, display_name } = data[0];
        const marker = L.marker([lat, lon], { draggable: true })
          .addTo(map)
          .bindPopup(display_name)
          .openPopup();
        marker.on('dragend', debounce(updateDestinations, 200));
        markers.push(marker);
        destinations.push({ name: display_name, lat: parseFloat(lat), lon: parseFloat(lon) });
        updateDestList();
        map.setView([lat, lon], 13);
        document.getElementById('address').value = '';
      } catch (e) {
        alert('Error al buscar la direcci√≥n. Intenta de nuevo.');
        console.error(e);
      }
    }

    // Actualizar destinos al arrastrar marcadores
    function updateDestinations() {
      destinations = markers.map((m, i) => ({
        name: destinations[i]?.name || `Destino ${i + 1}`,
        lat: m.getLatLng().lat,
        lon: m.getLatLng().lng
      }));
      updateDestList();
    }

    // Actualizar lista de destinos
    function updateDestList() {
      const list = document.getElementById('destList');
      const select = document.getElementById('destSelect');
      list.innerHTML = '';
      select.innerHTML = '<option value="">Selecciona un destino</option>';
      destinations.forEach((d, i) => {
        const div = document.createElement('div');
        div.className = 'dest-list-item';
        div.innerHTML = `
          <span class="text-sm">${d.name}</span>
          <div>
            <button onclick="editDest(${i})" class="text-blue-600 hover:text-blue-800" aria-label="Editar destino">‚úè</button>
            <button onclick="delDest(${i})" class="text-red-600 hover:text-red-800" aria-label="Eliminar destino">üóë</button>
          </div>`;
        list.appendChild(div);
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = d.name;
        select.appendChild(opt);
      });
    }

    // Editar destino
    function editDest(i) {
      const newName = prompt('Nuevo nombre para el destino:', destinations[i].name);
      if (newName) {
        destinations[i].name = newName;
        markers[i].bindPopup(newName);
        updateDestList();
      }
    }

    // Eliminar destino
    function delDest(i) {
      map.removeLayer(markers[i]);
      markers.splice(i, 1);
      destinations.splice(i, 1);
      updateDestList();
    }

    // Encontrar destino m√°s cercano
    function findNearest() {
      if (!userMarker || !destinations.length) {
        alert('No hay ubicaci√≥n actual o destinos registrados.');
        return;
      }
      const userLatLng = userMarker.getLatLng();
      let nearestIndex = 0, nearestDist = Infinity;
      destinations.forEach((d, i) => {
        const dist = map.distance(userLatLng, [d.lat, d.lon]);
        if (dist < nearestDist) {
          nearestDist = dist;
          nearestIndex = i;
        }
      });
      goToDest(nearestIndex);
    }

    // Ir al destino seleccionado
    function goToSelected() {
      const i = parseInt(document.getElementById('destSelect').value);
      if (!isNaN(i)) goToDest(i);
    }

    // Crear ruta al destino
    function goToDest(i) {
      if (!userMarker) {
        alert('Tu ubicaci√≥n no est√° disponible. Intenta establecer una ubicaci√≥n manual.');
        return;
      }
      if (routingControl) {
        map.removeControl(routingControl);
      }
      routingControl = L.Routing.control({
        waypoints: [userMarker.getLatLng(), L.latLng(destinations[i].lat, destinations[i].lon)],
        routeWhileDragging: true,
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true
      }).addTo(map);

      routingControl.on('routesfound', e => {
        const route = e.routes[0];
        const summary = route.summary;
        document.getElementById('routeInfo').innerHTML = `
          Distancia: ${(summary.totalDistance / 1000).toFixed(2)} km<br>
          Tiempo: ${(summary.totalTime / 60).toFixed(0)} min`;

        routeInstructions = [];
        nextInstructionIndex = 0;
        if (route.instructions) {
          route.instructions.forEach((inst, idx) => {
            const coordIndex = inst.index < route.coordinates.length ? inst.index : 0;
            const segment = route.coordinates[coordIndex];
            routeInstructions.push({ text: inst.text, lat: segment.lat, lng: segment.lng });
          });
        }
      });
    }

    // Establecer ubicaci√≥n manual
    async function setManualLocation() {
      const query = prompt('Ingresa una direcci√≥n para establecer tu ubicaci√≥n:');
      if (!query) return;
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (!data.length) {
          alert('Ubicaci√≥n no encontrada.');
          return;
        }
        const { lat, lon, display_name } = data[0];
        const userLatLng = L.latLng(lat, lon);
        if (!userMarker) {
          userMarker = L.marker(userLatLng)
            .addTo(map)
            .bindPopup('Tu ubicaci√≥n: ' + display_name)
            .openPopup();
        } else {
          userMarker.setLatLng(userLatLng);
          userMarker.bindPopup('Tu ubicaci√≥n: ' + display_name);
        }
        map.setView(userLatLng, 16);
      } catch (e) {
        alert('Error al buscar la ubicaci√≥n. Intenta de nuevo.');
        console.error(e);
      }
    }

    // Seguimiento de ubicaci√≥n en tiempo real
    function startGeolocation() {
      if (!navigator.geolocation) {
        alert('Tu navegador no soporta geolocalizaci√≥n. Por favor, usa la opci√≥n de ubicaci√≥n manual.');
        return;
      }
      navigator.geolocation.watchPosition(
        pos => {
          const { latitude: lat, longitude: lon } = pos.coords;
          const userLatLng = L.latLng(lat, lon);
          if (!userMarker) {
            userMarker = L.marker(userLatLng)
              .addTo(map)
              .bindPopup('Tu ubicaci√≥n')
              .openPopup();
          } else {
            userMarker.setLatLng(userLatLng);
          }

          if (routingControl) {
            const wp = routingControl.getWaypoints();
            wp[0].latLng = userLatLng;
            routingControl.setWaypoints([userLatLng, wp[1].latLng]);

            if (routeInstructions.length > nextInstructionIndex) {
              const inst = routeInstructions[nextInstructionIndex];
              const dist = map.distance(userLatLng, [inst.lat, inst.lng]);
              if (dist < 50) {
                speak(inst.text);
                nextInstructionIndex++;
              }
            }
          }
        },
        err => {
          let message = 'No se pudo obtener tu ubicaci√≥n.';
          switch (err.code) {
            case err.PERMISSION_DENIED:
              message = 'Permiso de geolocalizaci√≥n denegado. Por favor, habilita los permisos en la configuraci√≥n del navegador o usa la ubicaci√≥n manual.';
              break;
            case err.POSITION_UNAVAILABLE:
              message = 'La ubicaci√≥n no est√° disponible. Aseg√∫rate de que el GPS est√© activado o usa la ubicaci√≥n manual.';
              break;
            case err.TIMEOUT:
              message = 'Tiempo de espera agotado al obtener la ubicaci√≥n. Intenta de nuevo o usa la ubicaci√≥n manual.';
              break;
            default:
              message = 'Error desconocido al obtener la ubicaci√≥n. Usa la ubicaci√≥n manual.';
              break;
          }
          alert(message);
          console.warn('Error de geolocalizaci√≥n:', err);
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
      );
    }

    // Centrar el mapa en la ubicaci√≥n del usuario
    function locateMe() {
      if (userMarker) {
        map.setView(userMarker.getLatLng(), 16);
      } else {
        alert('Ubicaci√≥n no disponible. Intenta de nuevo o usa la ubicaci√≥n manual.');
      }
    }

    // Iniciar geolocalizaci√≥n al cargar la p√°gina
    startGeolocation();
  </script>
</body>
</html>
