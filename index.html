<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Paqueteria - Mapa de Rutas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <style>
    body { margin:0; font-family: 'Segoe UI', sans-serif; }
    #map { height: 100vh; width: 100%; }
    
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1000;
      width: 280px;
      font-size: 14px;
    }
    .controls input, .controls select, .controls button {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .controls button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }
    .controls button:hover {
      background-color: #0056b3;
    }
    .dest-list {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 5px;
      background: #f9f9f9;
    }
    .dest-list div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .dest-list button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 0 4px;
    }
    .route-info {
      margin-top: 10px;
      font-size: 13px;
      padding: 5px;
      background: #eef;
      border-radius: 6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <input id="address" placeholder="Buscar direccion para agregar"/>
  <button onclick="addAddress()">Agregar destino</button>

  <div class="dest-list" id="destList"></div>

  <button onclick="findNearest()">Destino mas cercano</button>
  <select id="destSelect"></select>
  <button onclick="goToSelected()">Ir</button>
  <button onclick="locateMe()">Donde estoy</button>

  <div class="route-info" id="routeInfo"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<script>
  const map = L.map('map').setView([23.6345, -102.5528], 5); // Mexico
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let destinations = [];
  let markers = [];
  let routingControl;

  // Posicion en tiempo real
  navigator.geolocation.watchPosition(pos => {
    const { latitude: lat, longitude: lon } = pos.coords;
    if (!window.userMarker) {
      window.userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Tu ubicacion").openPopup();
    } else {
      window.userMarker.setLatLng([lat, lon]);
    }
  }, err => console.warn(err), { enableHighAccuracy: true });

  async function addAddress() {
    const query = document.getElementById("address").value;
    if (!query) return alert("Ingresa una direccion");
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      if (data.length === 0) return alert("Direccion no encontrada");

      const { lat, lon } = data[0];
      const marker = L.marker([lat, lon], { draggable: true }).addTo(map).bindPopup(query).openPopup();
      marker.on("dragend", updateDestinations);
      markers.push(marker);
      destinations.push({ name: query, lat: parseFloat(lat), lon: parseFloat(lon) });
      updateDestList();
      map.setView([lat, lon], 13);
      document.getElementById("address").value = "";
    } catch (e) {
      alert("Error al buscar direccion");
      console.error(e);
    }
  }

  function updateDestinations() {
    destinations = markers.map((m, i) => ({
      name: destinations[i]?.name || "Destino " + (i+1),
      lat: m.getLatLng().lat,
      lon: m.getLatLng().lng
    }));
    updateDestList();
  }

  function updateDestList() {
    const list = document.getElementById("destList");
    const select = document.getElementById("destSelect");
    list.innerHTML = "";
    select.innerHTML = "";

    destinations.forEach((d, i) => {
      const div = document.createElement("div");
      div.innerHTML = `<span>${d.name}</span>
        <span>
          <button onclick="editDest(${i})">‚úè</button>
          <button onclick="delDest(${i})">üóë</button>
        </span>`;
      list.appendChild(div);

      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = d.name;
      select.appendChild(opt);
    });
  }

  function editDest(i) {
    const newName = prompt("Nuevo nombre:", destinations[i].name);
    if (newName) {
      destinations[i].name = newName;
      markers[i].bindPopup(newName);
      updateDestList();
    }
  }

  function delDest(i) {
    map.removeLayer(markers[i]);
    markers.splice(i, 1);
    destinations.splice(i, 1);
    updateDestList();
  }

  function findNearest() {
    if (!window.userMarker || destinations.length === 0) return alert("No hay ubicacion o destinos");
    const userLatLng = window.userMarker.getLatLng();
    let nearestIndex = 0;
    let nearestDist = Infinity;

    destinations.forEach((d, i) => {
      const dist = map.distance(userLatLng, [d.lat, d.lon]);
      if (dist < nearestDist) {
        nearestDist = dist;
        nearestIndex = i;
      }
    });
    goToDest(nearestIndex);
  }

  function goToSelected() {
    const i = document.getElementById("destSelect").value;
    if (i !== "" && i != null) goToDest(i);
  }

  function goToDest(i) {
    if (!window.userMarker) return alert("Tu ubicacion no esta disponible");
    if (routingControl) map.removeControl(routingControl);

    routingControl = L.Routing.control({
      waypoints: [window.userMarker.getLatLng(), L.latLng(destinations[i].lat, destinations[i].lon)],
      routeWhileDragging: false
    }).addTo(map);

    routingControl.on('routesfound', e => {
      const summary = e.routes[0].summary;
      document.getElementById("routeInfo").innerHTML =
        `Distancia: ${(summary.totalDistance/1000).toFixed(2)} km<br>
         Tiempo: ${(summary.totalTime/60).toFixed(0)} min`;
    });
  }

  function locateMe() {
    if (window.userMarker) map.setView(window.userMarker.getLatLng(), 15);
    else alert("Ubicacion no disponible");
  }
</script>

</body>
</html>
