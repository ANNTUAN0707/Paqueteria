<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Paqueteria - Mapa de Rutas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<style>
  body { margin:0; font-family: 'Segoe UI', sans-serif; }
  #map { height: 100vh; width: 100%; transition: margin-left 0.3s; }

  /* Sidebar */
  .sidebar {
    height: 100%;
    width: 0;
    position: fixed;
    z-index: 2000;
    top: 0;
    left: 0;
    background: #fff;
    overflow-x: hidden;
    transition: 0.3s;
    padding: 20px;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
  }
  .sidebar h2 { margin-top:0; }
  .sidebar input, .sidebar select, .sidebar button {
    width: 100%;
    margin: 6px 0;
    padding: 8px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  .sidebar button {
    background-color: #007bff;
    color: white;
    cursor: pointer;
    transition: background 0.3s;
  }
  .sidebar button:hover { background-color: #0056b3; }

  .dest-list {
    max-height: 200px;
    overflow-y: auto;
    margin: 8px 0;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 5px;
    background: #f9f9f9;
  }
  .dest-list div {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  .dest-list button { background:none; border:none; cursor:pointer; font-size:14px; padding:0 4px; }

  .route-info {
    margin-top: 10px;
    font-size: 13px;
    padding: 5px;
    background: #eef;
    border-radius: 6px;
  }

  /* Icono de abrir sidebar */
  .openbtn {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 2100;
    font-size: 20px;
    cursor: pointer;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
  }
</style>
</head>
<body>

<button class="openbtn" onclick="openSidebar()">‚ò∞ Destinos</button>

<div id="map"></div>

<div id="mySidebar" class="sidebar">
  <h2>Destinos</h2>
  <input id="address" placeholder="Buscar direccion"/>
  <button onclick="addAddress()">Agregar destino</button>

  <div class="dest-list" id="destList"></div>

  <button onclick="findNearest()">Destino m√°s cercano</button>
  <select id="destSelect"></select>
  <button onclick="goToSelected()">Ir</button>
  <button onclick="locateMe()">D√≥nde estoy</button>

  <div class="route-info" id="routeInfo"></div>
  <button style="margin-top:10px;" onclick="closeSidebar()">Cerrar</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<script>
const map = L.map('map').setView([23.6345, -102.5528], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let destinations = [];
let markers = [];
let routingControl;

// Sidebar
function openSidebar(){ document.getElementById("mySidebar").style.width = "280px"; map.getContainer().style.marginLeft="280px"; map.invalidateSize(); }
function closeSidebar(){ document.getElementById("mySidebar").style.width = "0"; map.getContainer().style.marginLeft="0"; map.invalidateSize(); }

// Posici√≥n en tiempo real
navigator.geolocation.watchPosition(pos => {
  const { latitude: lat, longitude: lon } = pos.coords;
  if (!window.userMarker) window.userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
  else window.userMarker.setLatLng([lat, lon]);
}, err => console.warn(err), { enableHighAccuracy: true });

async function addAddress() {
  const query = document.getElementById("address").value;
  if (!query) return alert("Ingresa una direcci√≥n");
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (!data.length) return alert("Direcci√≥n no encontrada");
    const { lat, lon } = data[0];
    const marker = L.marker([lat, lon], { draggable: true }).addTo(map).bindPopup(query).openPopup();
    marker.on("dragend", updateDestinations);
    markers.push(marker);
    destinations.push({ name: query, lat: parseFloat(lat), lon: parseFloat(lon) });
    updateDestList();
    map.setView([lat, lon], 13);
    document.getElementById("address").value = "";
  } catch(e){ alert("Error al buscar direcci√≥n"); console.error(e); }
}

function updateDestinations() {
  destinations = markers.map((m, i) => ({
    name: destinations[i]?.name || "Destino "+(i+1),
    lat: m.getLatLng().lat,
    lon: m.getLatLng().lng
  }));
  updateDestList();
}

function updateDestList() {
  const list = document.getElementById("destList");
  const select = document.getElementById("destSelect");
  list.innerHTML = ""; select.innerHTML = "";
  destinations.forEach((d, i) => {
    const div = document.createElement("div");
    div.innerHTML = `<span>${d.name}</span><span>
      <button onclick="editDest(${i})">‚úè</button>
      <button onclick="delDest(${i})">üóë</button></span>`;
    list.appendChild(div);
    const opt = document.createElement("option");
    opt.value = i; opt.textContent = d.name; select.appendChild(opt);
  });
}

function editDest(i) {
  const newName = prompt("Nuevo nombre:", destinations[i].name);
  if (newName) { destinations[i].name = newName; markers[i].bindPopup(newName); updateDestList(); }
}
function delDest(i){ map.removeLayer(markers[i]); markers.splice(i,1); destinations.splice(i,1); updateDestList(); }

function findNearest() {
  if (!window.userMarker || !destinations.length) return alert("No hay ubicaci√≥n o destinos");
  const userLatLng = window.userMarker.getLatLng();
  let nearestIndex = 0, nearestDist = Infinity;
  destinations.forEach((d,i)=>{
    const dist = map.distance(userLatLng,[d.lat,d.lon]);
    if(dist<nearestDist){ nearestDist=dist; nearestIndex=i; }
  });
  goToDest(nearestIndex);
}

function goToSelected() {
  const i = document.getElementById("destSelect").value;
  if(i!=="" && i!=null) goToDest(i);
}

function goToDest(i){
  if(!window.userMarker) return alert("Tu ubicaci√≥n no est√° disponible");
  if(routingControl) map.removeControl(routingControl);
  routingControl = L.Routing.control({
    waypoints: [window.userMarker.getLatLng(), L.latLng(destinations[i].lat,destinations[i].lon)],
    routeWhileDragging: false,
    show: false
  }).addTo(map);

  routingControl.on('routesfound', e => {
    const summary = e.routes[0].summary;
    document.getElementById("routeInfo").innerHTML =
      `Distancia: ${(summary.totalDistance/1000).toFixed(2)} km<br>
       Tiempo: ${(summary.totalTime/60).toFixed(0)} min`;
    speakInstructions(e.routes[0].instructions);
  });
}

// Voz
function speakInstructions(instructions){
  window.speechSynthesis.cancel();
  instructions.forEach((inst,index)=>{
    setTimeout(()=>{
      const msg = new SpeechSynthesisUtterance(inst.text);
      msg.lang='es-MX'; msg.rate=1;
      window.speechSynthesis.speak(msg);
    }, index*5000);
  });
}

function locateMe() { if(window.userMarker) map.setView(window.userMarker.getLatLng(),15); else alert("Ubicaci√≥n no disponible"); }
</script>

</body>
</html>

