<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Paqueter√≠a M√≥vil - Navegaci√≥n en Tiempo Real</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<style>
body { margin:0; font-family:'Segoe UI', sans-serif; }
#map { height:100vh; width:100%; transition: margin-left 0.3s; }

/* Sidebar deslizante */
.sidebar {
  height:100%;
  width:0;
  position:fixed;
  top:0; left:0;
  z-index:2000;
  background:#fff;
  overflow-x:hidden;
  transition:0.3s;
  padding:20px;
  box-shadow:2px 0 12px rgba(0,0,0,0.3);
  display:flex;
  flex-direction:column;
}
.sidebar h2 { margin-top:0; font-size:1.6em; color:#333; text-align:center; }
.sidebar input, .sidebar select, .sidebar button {
  width:100%; margin:10px 0; padding:14px; font-size:16px; border-radius:10px; border:1px solid #ccc; box-sizing:border-box;
}
.sidebar button { background-color:#28a745; color:white; cursor:pointer; transition:0.3s; font-weight:bold; }
.sidebar button:hover { background-color:#218838; }
.dest-list {
  max-height:250px;
  overflow-y:auto;
  margin:10px 0;
  border:1px solid #ddd;
  border-radius:10px;
  padding:5px;
  background:#f9f9f9;
}
.dest-list div {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:5px;
  padding:6px 8px;
  border-radius:6px;
  transition:0.2s;
}
.dest-list div:hover { background:#e0f7fa; }
.dest-list button { background:none; border:none; cursor:pointer; font-size:18px; padding:0 6px; color:#007bff; }
.dest-list button:hover { color:#0056b3; }

.route-info {
  margin-top:12px;
  font-size:15px;
  padding:10px;
  background:#e8f5e9;
  border-radius:8px;
  color:#2e7d32;
  text-align:center;
}

/* Boton abrir sidebar */
.openbtn {
  position:absolute; top:15px; left:15px; z-index:2100;
  font-size:26px; cursor:pointer; background-color:#007bff; color:white; border:none; padding:14px 18px; border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,0.2); transition:0.3s;
}
.openbtn:hover { background-color:#0056b3; }

/* Ajuste para m√≥viles */
@media (max-width:480px){
  .sidebar { padding:15px; }
  .sidebar input, .sidebar select, .sidebar button { font-size:16px; padding:12px; }
  .openbtn { font-size:24px; padding:12px 14px; }
}
</style>
</head>
<body>

<button class="openbtn" onclick="openSidebar()">‚ò∞ Destinos</button>

<div id="map"></div>

<div id="mySidebar" class="sidebar">
  <h2>Destinos</h2>
  <input id="address" placeholder="Buscar direcci√≥n"/>
  <button onclick="addAddress()">Agregar destino</button>
  <div class="dest-list" id="destList"></div>
  <button onclick="findNearest()">Destino m√°s cercano</button>
  <select id="destSelect"></select>
  <button onclick="goToSelected()">Ir</button>
  <button onclick="locateMe()">D√≥nde estoy</button>
  <div class="route-info" id="routeInfo">Ruta vac√≠a</div>
  <button style="margin-top:10px;" onclick="closeSidebar()">Cerrar</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>

<script>
const map = L.map('map').setView([23.6345, -102.5528],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

let destinations=[], markers=[], routingControl=null;
let routeInstructions=[], nextInstructionIndex=0;

// Sidebar
function openSidebar(){ 
  document.getElementById("mySidebar").style.width="300px"; 
  map.getContainer().style.marginLeft="300px"; 
  map.invalidateSize(); 
}
function closeSidebar(){ 
  document.getElementById("mySidebar").style.width="0"; 
  map.getContainer().style.marginLeft="0"; 
  map.invalidateSize(); 
}

// Funci√≥n voz
function speak(text){
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang='es-MX'; msg.rate=1;
  window.speechSynthesis.speak(msg);
}

// Funciones destinos
async function addAddress(){
  const query=document.getElementById("address").value;
  if(!query) return alert("Ingresa una direcci√≥n");
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data=await res.json();
    if(!data.length) return alert("Direcci√≥n no encontrada");
    const { lat, lon }=data[0];
    const marker = L.marker([lat,lon],{ draggable:true }).addTo(map).bindPopup(query).openPopup();
    marker.on("dragend",updateDestinations);
    markers.push(marker);
    destinations.push({name:query,lat:parseFloat(lat),lon:parseFloat(lon)});
    updateDestList();
    map.setView([lat,lon],13);
    document.getElementById("address").value="";
  } catch(e){ alert("Error al buscar direcci√≥n"); console.error(e);}
}

function updateDestinations(){
  destinations=markers.map((m,i)=>({name:destinations[i]?.name||"Destino "+(i+1),lat:m.getLatLng().lat,lon:m.getLatLng().lng}));
  updateDestList();
}

function updateDestList(){
  const list=document.getElementById("destList");
  const select=document.getElementById("destSelect");
  list.innerHTML=""; select.innerHTML="";
  destinations.forEach((d,i)=>{
    const div=document.createElement("div");
    div.innerHTML=`<span>${d.name}</span><span><button onclick="editDest(${i})">‚úè</button><button onclick="delDest(${i})">üóë</button></span>`;
    list.appendChild(div);
    const opt=document.createElement("option"); opt.value=i; opt.textContent=d.name; select.appendChild(opt);
  });
}

function editDest(i){
  const newName=prompt("Nuevo nombre:",destinations[i].name);
  if(newName){ destinations[i].name=newName; markers[i].bindPopup(newName); updateDestList(); }
}

function delDest(i){ map.removeLayer(markers[i]); markers.splice(i,1); destinations.splice(i,1); updateDestList(); }

function findNearest(){
  if(!window.userMarker||!destinations.length) return alert("No hay ubicaci√≥n o destinos");
  const userLatLng = window.userMarker.getLatLng();
  let nearestIndex=0, nearestDist=Infinity;
  destinations.forEach((d,i)=>{
    const dist=map.distance(userLatLng,[d.lat,d.lon]);
    if(dist<nearestDist){ nearestDist=dist; nearestIndex=i; }
  });
  goToDest(nearestIndex);
}

function goToSelected(){
  const i=parseInt(document.getElementById("destSelect").value);
  if(!isNaN(i)) goToDest(i);
}

function goToDest(i){
  if(!window.userMarker) return alert("Tu ubicaci√≥n no est√° disponible");
  if(routingControl) map.removeControl(routingControl);

  routingControl=L.Routing.control({
    waypoints:[window.userMarker.getLatLng(), L.latLng(destinations[i].lat,destinations[i].lon)],
    routeWhileDragging:true,
    show:false,
    addWaypoints:false,
    draggableWaypoints:false,
    fitSelectedRoutes:true
  }).addTo(map);

  routingControl.on('routesfound', e=>{
    const route=e.routes[0];
    const summary=route.summary;
    document.getElementById("routeInfo").innerHTML=
      `Distancia: ${(summary.totalDistance/1000).toFixed(2)} km<br>Tiempo: ${(summary.totalTime/60).toFixed(0)} min`;

    // Guardar instrucciones y coordenadas
    routeInstructions=[]; nextInstructionIndex=0;
    if(route.instructions){
      route.instructions.forEach(inst=>{
        const idx=inst.index<route.coordinates.length ? inst.index : 0;
        const segment=route.coordinates[idx];
        routeInstructions.push({text:inst.text,lat:segment.lat,lng:segment.lng});
      });
    }
  });
}

// Posici√≥n en tiempo real y actualizaci√≥n de ruta din√°mica
navigator.geolocation.watchPosition(pos=>{
  const { latitude: lat, longitude: lon } = pos.coords;
  const userLatLng = L.latLng(lat,lon);
  if(!window.userMarker){
    window.userMarker=L.marker(userLatLng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
  }else{
    window.userMarker.setLatLng(userLatLng);
  }

  if(routingControl){
    const wp=routingControl.getWaypoints();
    wp[0].latLng=userLatLng;
    routingControl.setWaypoints([userLatLng, wp[1].latLng]);

    // Voz en proximidad
    if(routeInstructions.length>nextInstructionIndex){
      const inst=routeInstructions[nextInstructionIndex];
      const dist=map.distance(userLatLng,[inst.lat,inst.lng]);
      if(dist<50){ speak(inst.text); nextInstructionIndex++; }
    }
  }
}, err=>console.warn(err), { enableHighAccuracy:true, maximumAge:0, timeout:5000 });

function locateMe(){ if(window.userMarker) map.setView(window.userMarker.getLatLng(),16); else alert("Ubicaci√≥n no disponible"); }
</script>

</body>
</html>
